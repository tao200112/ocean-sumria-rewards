(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,65503,64807,e=>{"use strict";var t,s=e.i(43476),a=e.i(71645),r=((t={}).UNKNOWN="UNKNOWN",t.CUSTOMER="CUSTOMER",t.STAFF="STAFF",t.ADMIN="ADMIN",t);e.s(["UserRole",()=>r,"normalizeRole",0,e=>{if(!e)return"CUSTOMER";let t=e.toUpperCase().trim();return"STAFF"===t?"STAFF":"ADMIN"===t?"ADMIN":"CUSTOMER"}],64807),r.CUSTOMER,r.CUSTOMER,r.STAFF,r.ADMIN;var o=e.i(64038);let i=async(e,t,s)=>{try{let e=await fetch("/api/staff/add-points",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({publicId:t,billAmountCents:Math.round(100*s),receiptRef:`REF-${Date.now()}`})}),a=await e.json();if(!e.ok)return{success:!1,message:a.error};return{success:!0,message:"Added points successfully",pointsAdded:a.data.new_points}}catch(e){return{success:!1,message:e.message}}},n=async(e,t)=>{try{console.log("[API] Converting points via RPC, spins:",t);let{data:e,error:s}=await o.supabase.rpc("rpc_convert_points_to_spins",{p_spin_count:t});if(console.log("[API] Convert result:",e,s),s)return{success:!1,message:s.message};if(e?.success===!1)return{success:!1,message:e.error||"Conversion failed"};return{success:!0,message:`Converted ${e.points_spent} points to ${e.spins_added} spins`,newPoints:e.new_points,newSpins:e.new_spins}}catch(e){return console.error("[API] convertPoints error:",e),{success:!1,message:e.message}}},l=async e=>{try{let e;console.log("[API] Spinning wheel via RPC...");let{data:t,error:s}=await o.supabase.rpc("rpc_spin");if(console.log("[API] Spin result:",t,s),s)return{ok:!1,error:s.message};if(!t?.ok)return{ok:!1,error:t?.error||"Spin failed"};let{outcome:a,prize:r,coupon_code:i,spins:n,points:l}=t;return"WIN"===a&&r&&(e={id:i||"temp",title:r.name,description:r.value||"Prize Reward",expiryDate:"7 days",isUsed:!1,type:"discount"===r.type?"DISCOUNT":"FREE_ITEM",code:i,imageUrl:"https://picsum.photos/seed/win/300/200",isNew:!0}),{ok:!0,prize:r||null,reward:e,outcome:a,newSpins:n,newPoints:l}}catch(e){return console.error("[API] spinWheel error:",e),{ok:!1,error:e.message}}},d=async(e,t)=>{try{let e=await fetch("/api/staff/redeem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t})});return(await e.json()).ok}catch(e){return console.error(e),!1}},u={currentUser:null,activeRole:r.UNKNOWN,users:{},rewards:[{id:"r1",title:"Free Calamari Appetizer",description:"Crispy, golden-fried calamari rings with marinara.",expiryDate:"2023-10-24",isUsed:!1,type:"FREE_ITEM",code:"XC-992-00",imageUrl:"https://picsum.photos/seed/calamari/300/200"},{id:"r2",title:"Spicy Tuna Roll",description:"Fresh tuna with spicy mayo.",expiryDate:"2023-11-01",isUsed:!1,type:"FREE_ITEM",code:"ST-112-99",imageUrl:"https://picsum.photos/seed/sushi/300/200"},{id:"r3",title:"10% Off Total Bill",description:"Valid for dine-in only.",expiryDate:"2023-10-20",isUsed:!0,type:"DISCOUNT",code:"10-OFF-OLD",imageUrl:"https://picsum.photos/seed/discount/300/200"}],logs:[{id:"l1",timestamp:"2023-10-24 10:42 AM",userId:"c1",publicId:"OS-8X29",userName:"Alex Johnson",userAvatar:"https://picsum.photos/seed/alex/50/50",action:"SPIN",details:"Won Free Drink",probabilityTier:"Tier 3"},{id:"l2",timestamp:"2023-10-24 09:15 AM",userId:"c2",publicId:"OS-331B",userName:"Sarah Connor",userAvatar:"https://picsum.photos/seed/alice/50/50",action:"REDEMPTION",details:"Redeemed 10% Off"},{id:"l3",timestamp:"2023-10-23 04:30 PM",userId:"s1",userName:"David Chen",userAvatar:"https://picsum.photos/seed/david/50/50",action:"EARN_POINTS",details:"Earned 105 Points ($105.00 Bill)"},{id:"l4",timestamp:"2023-10-23 05:00 PM",userId:"c1",publicId:"OS-8X29",userName:"Alex Johnson",userAvatar:"https://picsum.photos/seed/alex/50/50",action:"CONVERT_POINTS",details:"Converted 200 pts to 2 Spins"}],prizes:[{id:"p1",name:"Free Burger",weight:10,totalAvailable:500,winLimit:"1/day",active:!1,icon:"lunch_dining",color:"#f2a60d"},{id:"p2",name:"10% Off",weight:50,totalAvailable:"unlimited",winLimit:"None",active:!0,icon:"local_offer",color:"#3b82f6"},{id:"p3",name:"Mystery Box",weight:5,totalAvailable:10,winLimit:"1/user",active:!0,icon:"inventory_2",color:"#8b5cf6"},{id:"p4",name:"Free Drink",weight:80,totalAvailable:"unlimited",winLimit:"None",active:!0,icon:"local_bar",color:"#10b981"},{id:"p_lose",name:"Better Luck Next Time",weight:20,totalAvailable:"unlimited",winLimit:"None",active:!0,icon:"mood_bad",color:"#64748b"}],lastCreatedRewardId:null,isLoading:!0},p=(e,t)=>{switch(new Date().toLocaleString(),t.type){case"SET_USER":return console.log("REDUCER: SET_USER",t.payload),{...e,currentUser:t.payload,activeRole:t.payload?.role||r.CUSTOMER,isLoading:!1};case"SET_LOADING":return console.log("REDUCER: SET_LOADING",t.payload),{...e,isLoading:t.payload};case"UPDATE_USER_POINTS":if(!e.currentUser)return e;return{...e,currentUser:{...e.currentUser,points:t.payload.points,spins:t.payload.spins}};case"ADD_LOG":return{...e,logs:[t.payload,...e.logs]};case"ADD_REWARD":return{...e,rewards:[t.payload,...e.rewards],lastCreatedRewardId:t.payload.id};case"MARK_REWARD_USED":return{...e,rewards:e.rewards.map(e=>e.code===t.payload?{...e,isUsed:!0}:e)};case"CLEAR_NEW_REWARD_FLAG":return{...e,rewards:e.rewards.map(e=>({...e,isNew:!1})),lastCreatedRewardId:null};case"SET_LOGS":return{...e,logs:t.payload};default:return e}},c=(0,a.createContext)(void 0);e.s(["AppProvider",0,({children:e})=>{let[t,r]=(0,a.useReducer)(p,u);(0,a.useEffect)(()=>{},[]);let m=a.default.useMemo(()=>({logout:async()=>{await o.supabase.auth.signOut(),r({type:"SET_USER",payload:null})},grantSpinsByPublicId:async(e,t,s)=>{let a=await i(e,t,s);return a.success&&r({type:"ADD_LOG",payload:{id:`l-${Date.now()}`,timestamp:new Date().toLocaleString(),userId:e,userName:"Staff Member",userAvatar:"",action:"EARN_POINTS",details:`Earned ${a.pointsAdded} Points ($${s.toFixed(2)})`,publicId:t}}),a},earnPoints:async(e,t,s)=>{let a=await i(e,t,s);return a.success&&r({type:"ADD_LOG",payload:{id:`l-${Date.now()}`,timestamp:new Date().toLocaleString(),userId:e,userName:"Staff Member",userAvatar:"",action:"EARN_POINTS",details:`Earned ${a.pointsAdded} Points ($${s.toFixed(2)})`,publicId:t}}),a},convertPointsToSpins:async(e,t)=>{let s=await n(e,t);return s.success&&void 0!==s.newPoints&&void 0!==s.newSpins&&(r({type:"UPDATE_USER_POINTS",payload:{points:s.newPoints,spins:s.newSpins}}),r({type:"ADD_LOG",payload:{id:`l-${Date.now()}`,timestamp:new Date().toLocaleString(),userId:e,userName:"Customer",userAvatar:"",action:"CONVERT_POINTS",details:`Converted points to ${t} Spins`}})),s},spinWheel:async e=>{let t=await l(e);return t.ok&&(void 0!==t.newSpins&&void 0!==t.newPoints&&r({type:"UPDATE_USER_POINTS",payload:{points:t.newPoints,spins:t.newSpins}}),t.reward&&r({type:"ADD_REWARD",payload:{...t.reward,isNew:!0}}),r({type:"ADD_LOG",payload:{id:`l-${Date.now()}`,timestamp:new Date().toLocaleString(),userId:e,userName:"Customer",userAvatar:"",action:"SPIN",details:`Result: ${t.prize?.name||"No Win"}`}})),t},redeemCoupon:async(e,t)=>{let s=await d(e,t);return s&&(r({type:"MARK_REWARD_USED",payload:t}),r({type:"ADD_LOG",payload:{id:`l-${Date.now()}`,timestamp:new Date().toLocaleString(),userId:e,userName:"Staff Member",userAvatar:"",action:"REDEMPTION",details:`Redeemed Coupon: ${t}`}})),s},clearNewRewardFlag:()=>r({type:"CLEAR_NEW_REWARD_FLAG"}),setUser:e=>r({type:"SET_USER",payload:e}),setLoading:e=>r({type:"SET_LOADING",payload:e}),setLogs:e=>r({type:"SET_LOGS",payload:e})}),[r]);return(0,s.jsx)(c.Provider,{value:{state:t,actions:m},children:e})},"useAppStore",0,()=>{let e=(0,a.useContext)(c);if(!e)throw Error("useAppStore must be used within AppProvider");return e}],65503)},96923,e=>{"use strict";var t=e.i(43476),s=e.i(65503),a=e.i(71645),r=e.i(64038),o=e.i(64807);let i=(0,a.createContext)({loading:!0,session:null});function n({children:e}){let{actions:n}=(0,s.useAppStore)(),[l,d]=(0,a.useState)(null),[u,p]=(0,a.useState)(!0),[c,m]=(0,a.useState)(!1);(0,a.useEffect)(()=>{if(c)return;m(!0),console.log("[Auth] Initializing...");let e=async()=>{try{let{data:{session:e},error:t}=await r.supabase.auth.getSession();if(t){console.error("[Auth] getSession error:",t),p(!1),n.setLoading(!1);return}d(e),e?.user?(console.log("[Auth] Session found, fetching profile for:",e.user.id),await g(e.user)):(console.log("[Auth] No session"),n.setUser(null),p(!1),n.setLoading(!1))}catch(e){console.error("[Auth] Init error:",e),p(!1),n.setLoading(!1)}},{data:{subscription:t}}=r.supabase.auth.onAuthStateChange(async(e,t)=>{console.log("[Auth] Event:",e),d(t),"SIGNED_IN"===e&&t?.user?(console.log("[Auth] SIGNED_IN, loading profile..."),await g(t.user)):"SIGNED_OUT"===e&&(console.log("[Auth] SIGNED_OUT"),n.setUser(null),p(!1),n.setLoading(!1))});return e(),()=>{t.unsubscribe()}},[c,n]);let g=async e=>{console.log("[Auth] loadProfile called for:",e.id,e.email),p(!0),n.setLoading(!0);let t=setTimeout(()=>{console.error("[Auth] Profile load timeout - unlocking UI"),p(!1),n.setLoading(!1)},8e3);try{console.log("[Auth] Calling rpc_get_my_profile...");let{data:s,error:a}=await r.supabase.rpc("rpc_get_my_profile");if(clearTimeout(t),console.log("[Auth] RPC result:",{data:s,error:a}),a){console.error("[Auth] RPC error:",a.message),console.log("[Auth] Trying direct query...");let{data:t,error:s}=await r.supabase.from("profiles").select("*").eq("id",e.id).single();if(console.log("[Auth] Direct query result:",{data:t,error:s}),t){let s={id:t.id,publicId:t.public_id,name:t.name||e.email?.split("@")[0],email:t.email||e.email,role:(0,o.normalizeRole)(t.role),avatarUrl:`https://ui-avatars.com/api/?name=${t.email}&background=random`,points:t.points||0,spins:t.spins||0,joinedDate:new Date().toLocaleDateString()};console.log("[Auth] Profile loaded via direct query:",s.publicId),n.setUser(s)}else console.error("[Auth] No profile found!"),alert("Profile not found. Please contact support."),await r.supabase.auth.signOut(),n.setUser(null)}else if(s&&!s.error){let t={id:s.id,publicId:s.public_id,name:s.name||e.email?.split("@")[0],email:s.email||e.email,role:(0,o.normalizeRole)(s.role),avatarUrl:`https://ui-avatars.com/api/?name=${s.email}&background=random`,points:s.points||0,spins:s.spins||0,joinedDate:new Date().toLocaleDateString()};console.log("[Auth] Profile loaded via RPC:",t.publicId,t.role),n.setUser(t)}else console.error("[Auth] RPC returned error:",s?.error),alert("Profile not found. Please try signing in again."),await r.supabase.auth.signOut(),n.setUser(null)}catch(e){console.error("[Auth] loadProfile exception:",e),n.setUser(null)}finally{p(!1),n.setLoading(!1)}};return(0,t.jsx)(i.Provider,{value:{loading:u,session:l},children:e})}function l({children:e}){return(0,t.jsx)(s.AppProvider,{children:(0,t.jsx)(n,{children:e})})}e.s(["Providers",()=>l],96923)}]);