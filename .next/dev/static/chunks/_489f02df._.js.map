{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/types.ts"],"sourcesContent":["export enum UserRole {\n  UNKNOWN = 'UNKNOWN', // For initial loading state\n  CUSTOMER = 'CUSTOMER',\n  STAFF = 'STAFF',\n  ADMIN = 'ADMIN'\n}\n\nexport const normalizeRole = (role: string | null | undefined): UserRole => {\n  if (!role) return UserRole.CUSTOMER; // Default fallback for DB defaults\n  const normalized = role.toUpperCase().trim();\n  if (normalized === 'STAFF') return UserRole.STAFF;\n  if (normalized === 'ADMIN') return UserRole.ADMIN;\n  if (normalized === 'CUSTOMER') return UserRole.CUSTOMER;\n  return UserRole.CUSTOMER; // Safe default\n};\n\nexport interface User {\n  id: string;\n  publicId: string; // Unique 6-char ID for staff lookup (e.g., \"OS-9921\")\n  name: string;\n  email: string;\n  role: UserRole;\n  avatarUrl: string;\n  points?: number; // Customer only\n  spins?: number; // Customer only\n  joinedDate?: string;\n}\n\nexport interface Reward {\n  id: string;\n  title: string;\n  description: string;\n  expiryDate: string;\n  isUsed: boolean;\n  type: 'DISCOUNT' | 'FREE_ITEM' | 'BOGO';\n  code: string; // The QR code content\n  imageUrl: string;\n  isNew?: boolean; // To highlight newly won rewards\n}\n\nexport interface PrizeConfig {\n  id: string;\n  name: string;\n  weight: number; // Probability weight\n  totalAvailable: number | 'unlimited';\n  winLimit: string;\n  active: boolean;\n  icon: string;\n  color?: string; // For the wheel segment\n}\n\nexport interface ActivityLog {\n  id: string;\n  timestamp: string;\n  userId: string;\n  publicId?: string; // To show in logs\n  userName: string;\n  userAvatar: string;\n  action: 'SPIN' | 'REDEMPTION' | 'GRANT' | 'EARN_POINTS' | 'CONVERT_POINTS';\n  details: string; // \"Won 10% Off\" or \"Granted 3 spins\"\n  probabilityTier?: string;\n}\n\nexport interface SpinResult {\n  ok: boolean;\n  prize?: PrizeConfig;\n  reward?: Reward;\n  error?: string;\n  outcome?: 'WIN' | 'NO_WIN';\n}\n\nexport interface AppState {\n  currentUser: User | null;\n  activeRole: UserRole;\n  users: Record<string, User>; // Global registry of users\n  rewards: Reward[];\n  logs: ActivityLog[];\n  prizes: PrizeConfig[];\n  lastCreatedRewardId: string | null;\n}"],"names":[],"mappings":";;;;;;AAAO,IAAA,AAAK,kCAAA;;;;;WAAA;;AAOL,MAAM,gBAAgB,CAAC;IAC5B,IAAI,CAAC,MAAM,mBAA0B,mCAAmC;IACxE,MAAM,aAAa,KAAK,WAAW,GAAG,IAAI;IAC1C,IAAI,eAAe,SAAS;IAC5B,IAAI,eAAe,SAAS;IAC5B,IAAI,eAAe,YAAY;IAC/B,mBAA0B,eAAe;AAC3C"}},
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/services/mockData.ts"],"sourcesContent":["import { User, UserRole, Reward, PrizeConfig, ActivityLog } from '../types';\n\n// --- Mock Users ---\nexport const MOCK_USERS: Record<string, User> = {\n  customer: {\n    id: 'c1',\n    publicId: 'OS-8X29',\n    name: 'Alex Johnson',\n    email: 'alex.j@example.com',\n    role: UserRole.CUSTOMER,\n    avatarUrl: 'https://picsum.photos/seed/alex/100/100',\n    points: 350,\n    spins: 2,\n    joinedDate: 'Oct 2023'\n  },\n  customer2: {\n    id: 'c2',\n    publicId: 'OS-331B',\n    name: 'Sarah Connor',\n    email: 'sarah.c@example.com',\n    role: UserRole.CUSTOMER,\n    avatarUrl: 'https://picsum.photos/seed/sarah/100/100',\n    points: 120,\n    spins: 0,\n    joinedDate: 'Nov 2023'\n  },\n  staff: {\n    id: 's1',\n    publicId: 'ST-001',\n    name: 'David Chen',\n    email: 'staff@oceansumria.com',\n    role: UserRole.STAFF,\n    avatarUrl: 'https://picsum.photos/seed/david/100/100'\n  },\n  admin: {\n    id: 'a1',\n    publicId: 'AD-001',\n    name: 'Sarah Owner',\n    email: 'admin@oceansumria.com',\n    role: UserRole.ADMIN,\n    avatarUrl: 'https://picsum.photos/seed/sarah/100/100'\n  }\n};\n\n// --- Mock Rewards (Customer Wallet) ---\nexport const MOCK_REWARDS: Reward[] = [\n  {\n    id: 'r1',\n    title: 'Free Calamari Appetizer',\n    description: 'Crispy, golden-fried calamari rings with marinara.',\n    expiryDate: '2023-10-24',\n    isUsed: false,\n    type: 'FREE_ITEM',\n    code: 'XC-992-00',\n    imageUrl: 'https://picsum.photos/seed/calamari/300/200'\n  },\n  {\n    id: 'r2',\n    title: 'Spicy Tuna Roll',\n    description: 'Fresh tuna with spicy mayo.',\n    expiryDate: '2023-11-01',\n    isUsed: false,\n    type: 'FREE_ITEM',\n    code: 'ST-112-99',\n    imageUrl: 'https://picsum.photos/seed/sushi/300/200'\n  },\n  {\n    id: 'r3',\n    title: '10% Off Total Bill',\n    description: 'Valid for dine-in only.',\n    expiryDate: '2023-10-20',\n    isUsed: true,\n    type: 'DISCOUNT',\n    code: '10-OFF-OLD',\n    imageUrl: 'https://picsum.photos/seed/discount/300/200'\n  }\n];\n\n// --- Mock Prize Configuration (Admin) ---\nexport const MOCK_PRIZES: PrizeConfig[] = [\n  { id: 'p1', name: 'Free Burger', weight: 10, totalAvailable: 500, winLimit: '1/day', active: false, icon: 'lunch_dining', color: '#f2a60d' },\n  { id: 'p2', name: '10% Off', weight: 50, totalAvailable: 'unlimited', winLimit: 'None', active: true, icon: 'local_offer', color: '#3b82f6' },\n  { id: 'p3', name: 'Mystery Box', weight: 5, totalAvailable: 10, winLimit: '1/user', active: true, icon: 'inventory_2', color: '#8b5cf6' },\n  { id: 'p4', name: 'Free Drink', weight: 80, totalAvailable: 'unlimited', winLimit: 'None', active: true, icon: 'local_bar', color: '#10b981' },\n  // Adding a logic-only prize for \"No Win\" if weights don't add up, or explicit lose\n  { id: 'p_lose', name: 'Better Luck Next Time', weight: 20, totalAvailable: 'unlimited', winLimit: 'None', active: true, icon: 'mood_bad', color: '#64748b' }\n];\n\n// --- Mock Activity Logs ---\nexport const MOCK_LOGS: ActivityLog[] = [\n  {\n    id: 'l1',\n    timestamp: '2023-10-24 10:42 AM',\n    userId: 'c1',\n    publicId: 'OS-8X29',\n    userName: 'Alex Johnson',\n    userAvatar: 'https://picsum.photos/seed/alex/50/50',\n    action: 'SPIN',\n    details: 'Won Free Drink',\n    probabilityTier: 'Tier 3'\n  },\n  {\n    id: 'l2',\n    timestamp: '2023-10-24 09:15 AM',\n    userId: 'c2',\n    publicId: 'OS-331B',\n    userName: 'Sarah Connor',\n    userAvatar: 'https://picsum.photos/seed/alice/50/50',\n    action: 'REDEMPTION',\n    details: 'Redeemed 10% Off',\n  },\n  {\n    id: 'l3',\n    timestamp: '2023-10-23 04:30 PM',\n    userId: 's1',\n    userName: 'David Chen',\n    userAvatar: 'https://picsum.photos/seed/david/50/50',\n    action: 'EARN_POINTS',\n    details: 'Earned 105 Points ($105.00 Bill)',\n  },\n  {\n    id: 'l4',\n    timestamp: '2023-10-23 05:00 PM',\n    userId: 'c1',\n    publicId: 'OS-8X29',\n    userName: 'Alex Johnson',\n    userAvatar: 'https://picsum.photos/seed/alex/50/50',\n    action: 'CONVERT_POINTS',\n    details: 'Converted 200 pts to 2 Spins',\n  }\n];"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAGO,MAAM,aAAmC;IAC9C,UAAU;QACR,IAAI;QACJ,UAAU;QACV,MAAM;QACN,OAAO;QACP,MAAM,oHAAQ,CAAC,QAAQ;QACvB,WAAW;QACX,QAAQ;QACR,OAAO;QACP,YAAY;IACd;IACA,WAAW;QACT,IAAI;QACJ,UAAU;QACV,MAAM;QACN,OAAO;QACP,MAAM,oHAAQ,CAAC,QAAQ;QACvB,WAAW;QACX,QAAQ;QACR,OAAO;QACP,YAAY;IACd;IACA,OAAO;QACL,IAAI;QACJ,UAAU;QACV,MAAM;QACN,OAAO;QACP,MAAM,oHAAQ,CAAC,KAAK;QACpB,WAAW;IACb;IACA,OAAO;QACL,IAAI;QACJ,UAAU;QACV,MAAM;QACN,OAAO;QACP,MAAM,oHAAQ,CAAC,KAAK;QACpB,WAAW;IACb;AACF;AAGO,MAAM,eAAyB;IACpC;QACE,IAAI;QACJ,OAAO;QACP,aAAa;QACb,YAAY;QACZ,QAAQ;QACR,MAAM;QACN,MAAM;QACN,UAAU;IACZ;IACA;QACE,IAAI;QACJ,OAAO;QACP,aAAa;QACb,YAAY;QACZ,QAAQ;QACR,MAAM;QACN,MAAM;QACN,UAAU;IACZ;IACA;QACE,IAAI;QACJ,OAAO;QACP,aAAa;QACb,YAAY;QACZ,QAAQ;QACR,MAAM;QACN,MAAM;QACN,UAAU;IACZ;CACD;AAGM,MAAM,cAA6B;IACxC;QAAE,IAAI;QAAM,MAAM;QAAe,QAAQ;QAAI,gBAAgB;QAAK,UAAU;QAAS,QAAQ;QAAO,MAAM;QAAgB,OAAO;IAAU;IAC3I;QAAE,IAAI;QAAM,MAAM;QAAW,QAAQ;QAAI,gBAAgB;QAAa,UAAU;QAAQ,QAAQ;QAAM,MAAM;QAAe,OAAO;IAAU;IAC5I;QAAE,IAAI;QAAM,MAAM;QAAe,QAAQ;QAAG,gBAAgB;QAAI,UAAU;QAAU,QAAQ;QAAM,MAAM;QAAe,OAAO;IAAU;IACxI;QAAE,IAAI;QAAM,MAAM;QAAc,QAAQ;QAAI,gBAAgB;QAAa,UAAU;QAAQ,QAAQ;QAAM,MAAM;QAAa,OAAO;IAAU;IAC7I,mFAAmF;IACnF;QAAE,IAAI;QAAU,MAAM;QAAyB,QAAQ;QAAI,gBAAgB;QAAa,UAAU;QAAQ,QAAQ;QAAM,MAAM;QAAY,OAAO;IAAU;CAC5J;AAGM,MAAM,YAA2B;IACtC;QACE,IAAI;QACJ,WAAW;QACX,QAAQ;QACR,UAAU;QACV,UAAU;QACV,YAAY;QACZ,QAAQ;QACR,SAAS;QACT,iBAAiB;IACnB;IACA;QACE,IAAI;QACJ,WAAW;QACX,QAAQ;QACR,UAAU;QACV,UAAU;QACV,YAAY;QACZ,QAAQ;QACR,SAAS;IACX;IACA;QACE,IAAI;QACJ,WAAW;QACX,QAAQ;QACR,UAAU;QACV,YAAY;QACZ,QAAQ;QACR,SAAS;IACX;IACA;QACE,IAAI;QACJ,WAAW;QACX,QAAQ;QACR,UAAU;QACV,UAAU;QACV,YAAY;QACZ,QAAQ;QACR,SAAS;IACX;CACD"}},
    {"offset": {"line": 218, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/services/supabase.ts"],"sourcesContent":["import { createBrowserClient } from '@supabase/ssr';\n\n// Access env vars safely using Next.js standard\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.warn('Supabase URL or Key is missing. Check .env.local');\n}\n\nconst createClient = () => createBrowserClient(supabaseUrl, supabaseKey);\n\n// Use global singleton in dev to prevent multiple clients contesting for locks (AbortError fix)\nconst singleton = (globalThis as any).supabase ?? createClient();\n\nif (process.env.NODE_ENV !== 'production') {\n  (globalThis as any).supabase = singleton;\n}\n\nexport const supabase = singleton;"],"names":[],"mappings":";;;;AAGoB;AAHpB;AAAA;;AAEA,gDAAgD;AAChD,MAAM;AACN,MAAM;AAEN;;AAIA,MAAM,eAAe,IAAM,IAAA,oMAAmB,EAAC,aAAa;AAE5D,gGAAgG;AAChG,MAAM,YAAY,AAAC,WAAmB,QAAQ,IAAI;AAElD,wCAA2C;IACxC,WAAmB,QAAQ,GAAG;AACjC;AAEO,MAAM,WAAW"}},
    {"offset": {"line": 245, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/services/api.ts"],"sourcesContent":["import { supabase } from './supabase';\nimport { User, UserRole, ActivityLog, SpinResult, normalizeRole, Reward } from '../types';\nimport { MOCK_PRIZES } from './mockData'; // Keeping for fallback or types if needed, but logic is server side now\n\n/**\n * API Facade\n * \n * Connecting to Next.js API Routes.\n */\n\n// Utility: Timeout wrapper\nconst withTimeout = (promise: Promise<any>, ms: number, label: string) => {\n  return new Promise((resolve, reject) => {\n    const timer = setTimeout(() => {\n      console.warn(`[API] Timeout: ${label} took longer than ${ms}ms`);\n      reject(new Error(`Timeout: ${label}`));\n    }, ms);\n\n    promise\n      .then(res => {\n        clearTimeout(timer);\n        resolve(res);\n      })\n      .catch(err => {\n        clearTimeout(timer);\n        reject(err);\n      });\n  });\n};\n\nexport const api = {\n  /**\n   * Fetch User Profile with STRICT Handling\n   * GET /api/auth/me\n   */\n  fetchProfile: async (userId: string, email: string): Promise<User | null> => {\n    let attempts = 0;\n    while (attempts < 5) {\n      try {\n        // Use RPC for reliability (bypasses complex RLS)\n        const { data, error } = await supabase.rpc('rpc_get_my_profile');\n\n        if (error) {\n          console.warn(`[API] fetchProfile RPC error (attempt ${attempts}):`, error.message);\n        } else if (data && !data.error) {\n          // Found it!\n          return {\n            id: data.id,\n            publicId: data.public_id,\n            name: data.name || email.split('@')[0],\n            email: data.email || email,\n            role: normalizeRole(data.role),\n            avatarUrl: `https://ui-avatars.com/api/?name=${data.email}&background=random`,\n            points: data.points || 0,\n            spins: data.spins || 0,\n            joinedDate: new Date().toLocaleDateString()\n          };\n        } else if (data?.error) {\n          console.log(`[API] RPC returned error: ${data.error}, retrying... ${attempts + 1}/5`);\n        } else {\n          console.log(`[API] Profile missing, retrying... ${attempts + 1}/5`);\n        }\n      } catch (e) {\n        console.error(`[API] fetchProfile attempt ${attempts} crash:`, e);\n      }\n\n      // Short delay between retries\n      await new Promise(r => setTimeout(r, 800));\n      attempts++;\n    }\n\n    console.error('[API] fetchProfile failed after 5 attempts.');\n    return null;\n  },\n\n  /**\n   * ensureProfile: READ ONLY.\n   * We DO NOT create profiles on client anymore.\n   * If usage calls this, we just fetch.\n   */\n  ensureProfile: async (user: any) => {\n    // Just an alias for direct fetch now, wait for trigger\n    let attempts = 0;\n    while (attempts < 5) {\n      const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();\n      if (data) return data;\n      if (error) console.warn('Profile fetch error:', error);\n\n      // Wait 1s for trigger\n      await new Promise(r => setTimeout(r, 1000));\n      attempts++;\n    }\n    return null;\n  },\n\n  // --- RPC Wrappers ---\n\n  staffGetCustomer: async (publicId: string) => {\n    const { data, error } = await supabase.rpc('rpc_staff_get_customer_by_public_id', { public_id_query: publicId });\n    if (error) return { found: false, error: error.message };\n    return data; // { found: true, profile: ... }\n  },\n\n  staffAddPoints: async (publicId: string, amountCents: number) => {\n    const { data, error } = await supabase.rpc('rpc_staff_add_points', {\n      public_id_query: publicId,\n      bill_amount_cents: amountCents,\n      receipt_ref: 'manual'\n    });\n    if (error) return { status: 'error', message: error.message };\n    return data;\n  },\n\n  // Mapping old actions to RPCs where possible\n  // ... (Other existing methods) ...\n\n  /**\n   * Staff: Add Points to Customer\n   * POST /api/staff/add-points\n   */\n  addPoints: async (staffId: string, customerPublicId: string, billAmount: number) => {\n    try {\n      const res = await fetch('/api/staff/add-points', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ publicId: customerPublicId, billAmountCents: Math.round(billAmount * 100), receiptRef: `REF-${Date.now()}` })\n      });\n      const json = await res.json();\n      if (!res.ok) return { success: false, message: json.error };\n\n      return { success: true, message: `Added points successfully`, pointsAdded: json.data.new_points };\n    } catch (e) {\n      return { success: false, message: (e as Error).message };\n    }\n  },\n\n  /**\n   * Customer: Convert Points to Spins\n   * POST /api/customer/convert-points\n   */\n  convertPoints: async (customerId: string, spinsToBuy: number) => {\n    try {\n      console.log('[API] Converting points via RPC, spins:', spinsToBuy);\n      const { data, error } = await supabase.rpc('rpc_convert_points_to_spins', {\n        p_spin_count: spinsToBuy\n      });\n\n      console.log('[API] Convert result:', data, error);\n\n      if (error) {\n        return { success: false, message: error.message };\n      }\n\n      if (data?.success === false) {\n        return { success: false, message: data.error || 'Conversion failed' };\n      }\n\n      return {\n        success: true,\n        message: `Converted ${data.points_spent} points to ${data.spins_added} spins`,\n        newPoints: data.new_points,\n        newSpins: data.new_spins\n      };\n    } catch (e) {\n      console.error('[API] convertPoints error:', e);\n      return { success: false, message: (e as Error).message };\n    }\n  },\n\n  /**\n   * Customer: Spin the Wheel\n   * POST /api/customer/spin\n   */\n  spinWheel: async (customerId: string) => {\n    try {\n      console.log('[API] Spinning wheel via RPC...');\n      const { data, error } = await supabase.rpc('rpc_spin');\n\n      console.log('[API] Spin result:', data, error);\n\n      if (error) {\n        return { ok: false, error: error.message };\n      }\n\n      if (!data?.ok) {\n        return { ok: false, error: data?.error || 'Spin failed' };\n      }\n\n      const { outcome, prize, coupon_code, spins, points } = data;\n\n      let reward: Reward | undefined;\n      if (outcome === 'WIN' && prize) {\n        reward = {\n          id: coupon_code || 'temp',\n          title: prize.name,\n          description: prize.value || 'Prize Reward',\n          expiryDate: '7 days',\n          isUsed: false,\n          type: prize.type === 'discount' ? 'DISCOUNT' : 'FREE_ITEM',\n          code: coupon_code,\n          imageUrl: 'https://picsum.photos/seed/win/300/200',\n          isNew: true\n        };\n      }\n\n      return {\n        ok: true,\n        prize: prize || null,\n        reward,\n        outcome: outcome,\n        newSpins: spins,\n        newPoints: points\n      };\n    } catch (e) {\n      console.error('[API] spinWheel error:', e);\n      return { ok: false, error: (e as Error).message };\n    }\n  },\n\n  /**\n   * Staff: Redeem Coupon\n   * POST /api/staff/redeem\n   */\n  redeemCoupon: async (staffId: string, code: string) => {\n    try {\n      const res = await fetch('/api/staff/redeem', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ code })\n      });\n      const json = await res.json();\n      return json.ok;\n    } catch (e) {\n      console.error(e);\n      return false;\n    }\n  },\n\n  /**\n   * Admin: Fetch Logs\n   * GET /api/admin/audit-logs\n   */\n  getLogs: async () => {\n    try {\n      const res = await fetch('/api/admin/audit-logs');\n      const json = await res.json();\n      if (!res.ok) return [];\n\n      // Map to frontend ActivityLog type\n      return json.data.map((log: any) => ({\n        id: log.id,\n        timestamp: new Date(log.created_at).toLocaleString(),\n        userId: log.actor_id,\n        userName: log.profiles?.name || 'Unknown',\n        userAvatar: '',\n        action: log.type,\n        details: JSON.stringify(log.metadata)\n      }));\n    } catch (e) {\n      console.error(e);\n      return [];\n    }\n  },\n\n  /**\n   * Admin: Publish Prize Pool\n   * POST /api/admin/pool/publish\n   */\n  publishPool: async (poolVersionId: string) => {\n    try {\n      const res = await fetch('/api/admin/pool/publish', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ poolVersionId })\n      });\n      const json = await res.json();\n      return { success: res.ok, message: json.ok ? 'Published' : json.error };\n    } catch (e) {\n      return { success: false, message: (e as Error).message };\n    }\n  }\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 553, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/services/store.tsx"],"sourcesContent":["import React, { createContext, useContext, useReducer, ReactNode, useEffect } from 'react';\nimport { User, Reward, PrizeConfig, ActivityLog, AppState, UserRole, SpinResult } from '../types';\nimport { MOCK_REWARDS, MOCK_PRIZES, MOCK_LOGS } from './mockData';\nimport { supabase } from './supabase';\nimport { api } from './api';\n\n// --- Types & Actions ---\ntype Action =\n  | { type: 'SET_USER'; payload: User | null }\n  | { type: 'UPDATE_USER_POINTS'; payload: { points: number; spins: number } }\n  | { type: 'ADD_LOG'; payload: ActivityLog }\n  | { type: 'ADD_REWARD'; payload: Reward }\n  | { type: 'MARK_REWARD_USED'; payload: string }\n  | { type: 'SET_LOADING'; payload: boolean }\n  | { type: 'SET_LOADING'; payload: boolean }\n  | { type: 'CLEAR_NEW_REWARD_FLAG' }\n  | { type: 'SET_LOGS'; payload: ActivityLog[] };\n\ninterface AppContextType {\n  state: AppState & { isLoading: boolean };\n  actions: {\n    logout: () => Promise<void>;\n    grantSpinsByPublicId: (staffId: string, publicId: string, billAmount: number) => Promise<{ success: boolean; message: string }>;\n    earnPoints: (staffId: string, publicId: string, billAmount: number) => Promise<{ success: boolean; message: string }>;\n    convertPointsToSpins: (customerId: string, spinsToBuy: number) => Promise<{ success: boolean; message: string }>;\n    spinWheel: (customerId: string) => Promise<SpinResult>;\n    redeemCoupon: (staffId: string, code: string) => Promise<boolean>;\n    clearNewRewardFlag: () => void;\n    // System Actions\n    setUser: (user: User | null) => void;\n    setLoading: (loading: boolean) => void;\n    setLogs: (logs: ActivityLog[]) => void;\n  };\n}\n\n// --- Initial State ---\nconst initialState: AppState & { isLoading: boolean } = {\n  currentUser: null,\n  activeRole: UserRole.UNKNOWN, // Start unknown\n  users: {}, // Only used for lookup cache in this version\n  rewards: MOCK_REWARDS,\n  logs: MOCK_LOGS,\n  prizes: MOCK_PRIZES,\n  lastCreatedRewardId: null,\n  isLoading: true,\n};\n\n// --- Reducer ---\nconst appReducer = (state: AppState & { isLoading: boolean }, action: Action): AppState & { isLoading: boolean } => {\n  const timestamp = new Date().toLocaleString();\n\n  switch (action.type) {\n    case 'SET_USER':\n      console.log('REDUCER: SET_USER', action.payload);\n      return {\n        ...state,\n        currentUser: action.payload,\n        activeRole: action.payload?.role || UserRole.CUSTOMER,\n        isLoading: false,\n      };\n\n    case 'SET_LOADING':\n      console.log('REDUCER: SET_LOADING', action.payload);\n      return { ...state, isLoading: action.payload };\n\n    case 'UPDATE_USER_POINTS':\n      if (!state.currentUser) return state;\n      return {\n        ...state,\n        currentUser: {\n          ...state.currentUser,\n          points: action.payload.points,\n          spins: action.payload.spins\n        }\n      };\n\n    case 'ADD_LOG':\n      return { ...state, logs: [action.payload, ...state.logs] };\n\n    case 'ADD_REWARD':\n      return {\n        ...state,\n        rewards: [action.payload, ...state.rewards],\n        lastCreatedRewardId: action.payload.id\n      };\n\n    case 'MARK_REWARD_USED':\n      return {\n        ...state,\n        rewards: state.rewards.map(r => r.code === action.payload ? { ...r, isUsed: true } : r)\n      };\n\n    case 'CLEAR_NEW_REWARD_FLAG':\n      return { ...state, rewards: state.rewards.map(r => ({ ...r, isNew: false })), lastCreatedRewardId: null };\n\n    case 'SET_LOGS':\n      return { ...state, logs: action.payload };\n\n    default:\n      return state;\n  }\n};\n\n// --- Provider ---\nconst AppContext = createContext<AppContextType | undefined>(undefined);\n\nexport const AppProvider = ({ children }: { children: ReactNode }) => {\n  const [state, dispatch] = useReducer(appReducer, initialState);\n\n  // --- Auth Listener ---\n  // Moved to AuthProvider to avoid race conditions and improve architecture\n  useEffect(() => {\n    // Initial state is loading\n    // AuthProvider will handle SET_USER and SET_LOADING\n  }, []);\n\n\n  // --- Actions (Async Wrappers around API) ---\n\n  // --- Actions (Async Wrappers around API) ---\n\n  const actions = React.useMemo(() => ({\n    logout: async () => {\n      await supabase.auth.signOut();\n      dispatch({ type: 'SET_USER', payload: null });\n    },\n    grantSpinsByPublicId: async (staffId: string, publicId: string, billAmount: number) => {\n      const res = await api.addPoints(staffId, publicId, billAmount);\n      if (res.success) {\n        dispatch({\n          type: 'ADD_LOG',\n          payload: {\n            id: `l-${Date.now()}`,\n            timestamp: new Date().toLocaleString(),\n            userId: staffId,\n            userName: 'Staff Member',\n            userAvatar: '',\n            action: 'EARN_POINTS',\n            details: `Earned ${res.pointsAdded} Points ($${billAmount.toFixed(2)})`,\n            publicId\n          }\n        });\n      }\n      return res;\n    },\n    earnPoints: async (staffId: string, publicId: string, billAmount: number) => {\n      // Just call logic directly since we can't self-reference easily in object literal init\n      const res = await api.addPoints(staffId, publicId, billAmount);\n      if (res.success) {\n        dispatch({\n          type: 'ADD_LOG',\n          payload: {\n            id: `l-${Date.now()}`,\n            timestamp: new Date().toLocaleString(),\n            userId: staffId,\n            userName: 'Staff Member',\n            userAvatar: '',\n            action: 'EARN_POINTS',\n            details: `Earned ${res.pointsAdded} Points ($${billAmount.toFixed(2)})`,\n            publicId\n          }\n        });\n      }\n      return res;\n    },\n    convertPointsToSpins: async (customerId: string, spinsToBuy: number) => {\n      const res = await api.convertPoints(customerId, spinsToBuy);\n      if (res.success && res.newPoints !== undefined && res.newSpins !== undefined) {\n        dispatch({ type: 'UPDATE_USER_POINTS', payload: { points: res.newPoints, spins: res.newSpins } });\n        dispatch({\n          type: 'ADD_LOG',\n          payload: {\n            id: `l-${Date.now()}`,\n            timestamp: new Date().toLocaleString(),\n            userId: customerId,\n            userName: 'Customer',\n            userAvatar: '',\n            action: 'CONVERT_POINTS',\n            details: `Converted points to ${spinsToBuy} Spins`\n          }\n        });\n      }\n      return res;\n    },\n    spinWheel: async (customerId: string): Promise<SpinResult> => {\n      const res = await api.spinWheel(customerId);\n      if (res.ok) {\n        // Use actual values from RPC response\n        if (res.newSpins !== undefined && res.newPoints !== undefined) {\n          dispatch({ type: 'UPDATE_USER_POINTS', payload: { points: res.newPoints, spins: res.newSpins } });\n        }\n        if (res.reward) {\n          dispatch({ type: 'ADD_REWARD', payload: { ...res.reward, isNew: true } });\n        }\n        dispatch({\n          type: 'ADD_LOG',\n          payload: {\n            id: `l-${Date.now()}`,\n            timestamp: new Date().toLocaleString(),\n            userId: customerId,\n            userName: 'Customer',\n            userAvatar: '',\n            action: 'SPIN',\n            details: `Result: ${res.prize?.name || 'No Win'}`,\n          }\n        });\n      }\n      return res as SpinResult;\n    },\n    redeemCoupon: async (staffId: string, code: string): Promise<boolean> => {\n      const success = await api.redeemCoupon(staffId, code);\n      if (success) {\n        dispatch({ type: 'MARK_REWARD_USED', payload: code });\n        dispatch({\n          type: 'ADD_LOG',\n          payload: {\n            id: `l-${Date.now()}`,\n            timestamp: new Date().toLocaleString(),\n            userId: staffId,\n            userName: 'Staff Member',\n            userAvatar: '',\n            action: 'REDEMPTION',\n            details: `Redeemed Coupon: ${code}`,\n          }\n        });\n      }\n      return success;\n    },\n    clearNewRewardFlag: () => dispatch({ type: 'CLEAR_NEW_REWARD_FLAG' }),\n    setUser: (user: User | null) => dispatch({ type: 'SET_USER', payload: user }),\n    setLoading: (loading: boolean) => dispatch({ type: 'SET_LOADING', payload: loading }),\n    setLogs: (logs: ActivityLog[]) => dispatch({ type: 'SET_LOGS', payload: logs })\n  }), [dispatch]); // Actions ONLY depend on dispatch, making them stable across renders.\n\n  // We need to fetch points/logs inside the actions if we want current state, \n  // but for the purpose of fixing the Infinite Loading, ensuring 'actions' object identity is stable is key.\n  // The 'earnPoints' logic referencing 'state' was removed or simplified. \n  // Original 'earnPoints' alias 'grantSpinsByPublicId' just called earnPoints.\n\n  // Re-implement earnPoints logic properly if it needed 'state'.\n  // Looking at original code: 'earnPoints' used 'state.currentUser.points'.\n  // To fix this without breaking stability: valid actions shouldn't rely on closure state.\n  // We'll rely on the API response or fresh fetch for strict correctness, or just ignore the optimistic calc for points for now.\n\n  return (\n    <AppContext.Provider value={{ state, actions }}>\n      {children}\n    </AppContext.Provider>\n  );\n};\n\nexport const useAppStore = () => {\n  const context = useContext(AppContext);\n  if (!context) throw new Error('useAppStore must be used within AppProvider');\n  return context;\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 878, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/components/auth/AuthProvider.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { createContext, useContext, useEffect, useState } from 'react';\r\nimport { supabase } from '@/services/supabase';\r\nimport { useAppStore } from '@/services/store';\r\nimport { api } from '@/services/api';\r\nimport { UserRole, normalizeRole } from '@/types';\r\n\r\ninterface AuthContextType {\r\n    loading: boolean;\r\n    session: any;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType>({ loading: true, session: null });\r\n\r\nexport const useAuth = () => useContext(AuthContext);\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n    const { actions } = useAppStore();\r\n    const [session, setSession] = useState<any>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [initialized, setInitialized] = useState(false);\r\n\r\n    // Single initialization effect\r\n    useEffect(() => {\r\n        if (initialized) return;\r\n        setInitialized(true);\r\n\r\n        console.log('[Auth] Initializing...');\r\n\r\n        const initAuth = async () => {\r\n            try {\r\n                // 1. Get current session\r\n                const { data: { session: currentSession }, error } = await supabase.auth.getSession();\r\n\r\n                if (error) {\r\n                    console.error('[Auth] getSession error:', error);\r\n                    setLoading(false);\r\n                    actions.setLoading(false);\r\n                    return;\r\n                }\r\n\r\n                setSession(currentSession);\r\n\r\n                if (currentSession?.user) {\r\n                    console.log('[Auth] Session found, fetching profile for:', currentSession.user.id);\r\n                    await loadProfile(currentSession.user);\r\n                } else {\r\n                    console.log('[Auth] No session');\r\n                    actions.setUser(null);\r\n                    setLoading(false);\r\n                    actions.setLoading(false);\r\n                }\r\n            } catch (e) {\r\n                console.error('[Auth] Init error:', e);\r\n                setLoading(false);\r\n                actions.setLoading(false);\r\n            }\r\n        };\r\n\r\n        // Listen for auth changes\r\n        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event: string, newSession: any) => {\r\n            console.log('[Auth] Event:', event);\r\n            setSession(newSession);\r\n\r\n            if (event === 'SIGNED_IN' && newSession?.user) {\r\n                console.log('[Auth] SIGNED_IN, loading profile...');\r\n                await loadProfile(newSession.user);\r\n            } else if (event === 'SIGNED_OUT') {\r\n                console.log('[Auth] SIGNED_OUT');\r\n                actions.setUser(null);\r\n                setLoading(false);\r\n                actions.setLoading(false);\r\n            }\r\n        });\r\n\r\n        initAuth();\r\n\r\n        return () => {\r\n            subscription.unsubscribe();\r\n        };\r\n    }, [initialized, actions]);\r\n\r\n    // Profile loader function\r\n    const loadProfile = async (user: any) => {\r\n        console.log('[Auth] loadProfile called for:', user.id, user.email);\r\n        setLoading(true);\r\n        actions.setLoading(true);\r\n\r\n        // Hard timeout protection\r\n        const timeout = setTimeout(() => {\r\n            console.error('[Auth] Profile load timeout - unlocking UI');\r\n            setLoading(false);\r\n            actions.setLoading(false);\r\n        }, 8000);\r\n\r\n        try {\r\n            // Try RPC first\r\n            console.log('[Auth] Calling rpc_get_my_profile...');\r\n            const { data: rpcData, error: rpcError } = await supabase.rpc('rpc_get_my_profile');\r\n\r\n            clearTimeout(timeout);\r\n            console.log('[Auth] RPC result:', { data: rpcData, error: rpcError });\r\n\r\n            if (rpcError) {\r\n                console.error('[Auth] RPC error:', rpcError.message);\r\n                // Try direct query as fallback\r\n                console.log('[Auth] Trying direct query...');\r\n                const { data: directData, error: directError } = await supabase\r\n                    .from('profiles')\r\n                    .select('*')\r\n                    .eq('id', user.id)\r\n                    .single();\r\n\r\n                console.log('[Auth] Direct query result:', { data: directData, error: directError });\r\n\r\n                if (directData) {\r\n                    const profile = {\r\n                        id: directData.id,\r\n                        publicId: directData.public_id,\r\n                        name: directData.name || user.email?.split('@')[0],\r\n                        email: directData.email || user.email,\r\n                        role: normalizeRole(directData.role),\r\n                        avatarUrl: `https://ui-avatars.com/api/?name=${directData.email}&background=random`,\r\n                        points: directData.points || 0,\r\n                        spins: directData.spins || 0,\r\n                        joinedDate: new Date().toLocaleDateString()\r\n                    };\r\n                    console.log('[Auth] Profile loaded via direct query:', profile.publicId);\r\n                    actions.setUser(profile);\r\n                } else {\r\n                    console.error('[Auth] No profile found!');\r\n                    alert('Profile not found. Please contact support.');\r\n                    await supabase.auth.signOut();\r\n                    actions.setUser(null);\r\n                }\r\n            } else if (rpcData && !rpcData.error) {\r\n                const profile = {\r\n                    id: rpcData.id,\r\n                    publicId: rpcData.public_id,\r\n                    name: rpcData.name || user.email?.split('@')[0],\r\n                    email: rpcData.email || user.email,\r\n                    role: normalizeRole(rpcData.role),\r\n                    avatarUrl: `https://ui-avatars.com/api/?name=${rpcData.email}&background=random`,\r\n                    points: rpcData.points || 0,\r\n                    spins: rpcData.spins || 0,\r\n                    joinedDate: new Date().toLocaleDateString()\r\n                };\r\n                console.log('[Auth] Profile loaded via RPC:', profile.publicId, profile.role);\r\n                actions.setUser(profile);\r\n            } else {\r\n                console.error('[Auth] RPC returned error:', rpcData?.error);\r\n                alert('Profile not found. Please try signing in again.');\r\n                await supabase.auth.signOut();\r\n                actions.setUser(null);\r\n            }\r\n        } catch (e) {\r\n            console.error('[Auth] loadProfile exception:', e);\r\n            actions.setUser(null);\r\n        } finally {\r\n            setLoading(false);\r\n            actions.setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={{ loading, session }}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1076, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yesod/Desktop/ocean-sumria-rewards/app/providers.tsx"],"sourcesContent":["'use client'\r\nimport { AppProvider } from '@/services/store'\r\nimport { AuthProvider } from '@/components/auth/AuthProvider'\r\n\r\nexport function Providers({ children }: { children: React.ReactNode }) {\r\n    return (\r\n        <AppProvider>\r\n            <AuthProvider>\r\n                {children}\r\n            </AuthProvider>\r\n        </AppProvider>\r\n    )\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;AACA;AAFA;;;;AAIO,SAAS,UAAU,EAAE,QAAQ,EAAiC;IACjE,qBACI,6LAAC,oIAAW;kBACR,cAAA,6LAAC,sJAAY;sBACR;;;;;;;;;;;AAIjB;KARgB"}}]
}